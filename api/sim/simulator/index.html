
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A comprehensive simulation package for arthropod behavior.">
      
      
        <meta name="author" content="Rishika Mohanta">
      
      
      
        <link rel="prev" href="../../">
      
      
        <link rel="next" href="../arena/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Simulator - ArthroScape</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#simulator" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="ArthroScape" class="md-header__button md-logo" aria-label="ArthroScape" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ArthroScape
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Simulator
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/neurorishika/ArthroScape" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    neurorishika/ArthroScape
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../installation/" class="md-tabs__link">
        
  
  
    
  
  Installation

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../usage/" class="md-tabs__link">
        
  
  
    
  
  Usage

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../architecture/" class="md-tabs__link">
        
  
  
    
  
  Architecture & Internals

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../tutorials/getting_started/" class="md-tabs__link">
          
  
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../how-to/parallel_simulations/" class="md-tabs__link">
          
  
  
  How-To Guides

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="ArthroScape" class="md-nav__button md-logo" aria-label="ArthroScape" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ArthroScape
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/neurorishika/ArthroScape" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    neurorishika/ArthroScape
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture & Internals
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/custom_arena/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Customizing the Arena
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/custom_behavior/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Creating Custom Behaviors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    How-To Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    How-To Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/parallel_simulations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Parallel Simulations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Visualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/data_analysis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../how-to/external_odor_sources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    External Odor Sources
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_2" checked>
        
          
          <label class="md-nav__link" for="__nav_7_2" id="__nav_7_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Simulation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Simulation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Simulator
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Simulator
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#arthroscape.sim.simulator" class="md-nav__link">
    <span class="md-ellipsis">
      
        simulator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="simulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#arthroscape.sim.simulator.MultiAnimalSimulator" class="md-nav__link">
    <span class="md-ellipsis">
      
        MultiAnimalSimulator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MultiAnimalSimulator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#arthroscape.sim.simulator.MultiAnimalSimulator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arthroscape.sim.simulator.MultiAnimalSimulator.simulate" class="md-nav__link">
    <span class="md-ellipsis">
      
        simulate
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#arthroscape.sim.simulator.MultiAnimalSimulator.simulate_vectorized" class="md-nav__link">
    <span class="md-ellipsis">
      
        simulate_vectorized
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../arena/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Arena
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../behavior/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Behavior
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../odor_perception/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Odor Perception
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../odor_release/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Odor Release
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../odor_sources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Odor Sources
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Runner
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../saver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Saver
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../visualization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Visualization
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../directional_persistence/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Directional Persistence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="simulator">Simulator</h1>


<div class="doc doc-object doc-module">



<h2 id="arthroscape.sim.simulator" class="doc doc-heading">
            <code>arthroscape.sim.simulator</code>


</h2>

    <div class="doc doc-contents first">

        <p>Core simulation engine for ArthroScape.</p>
<p>This module defines the <code>MultiAnimalSimulator</code> class, which orchestrates the simulation loop.
It manages the state of multiple animals, their interactions with the arena (odor deposition,
sensing, movement), and the evolution of the odor field over time.</p>










  <div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="arthroscape.sim.simulator.MultiAnimalSimulator" class="doc doc-heading">
            <code>MultiAnimalSimulator</code>


</h3>


    <div class="doc doc-contents ">



        <p>Simulator for multiple animals in an odor arena.</p>
<p>This class manages the main simulation loop, updating animal states, positions,
and the odor field at each time step. It supports both a standard sequential
simulation method and a vectorized version for better performance with many animals.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>arthroscape/sim/simulator.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="k">class</span><span class="w"> </span><span class="nc">MultiAnimalSimulator</span><span class="p">:</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    Simulator for multiple animals in an odor arena.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    This class manages the main simulation loop, updating animal states, positions,</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    and the odor field at each time step. It supports both a standard sequential</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    simulation method and a vectorized version for better performance with many animals.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="n">config</span><span class="p">:</span> <span class="n">SimulationConfig</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="n">behavior</span><span class="p">:</span> <span class="n">BehaviorAlgorithm</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="n">arena</span><span class="p">:</span> <span class="n">Arena</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="n">odor_release_strategy</span><span class="p">:</span> <span class="n">OdorReleaseStrategy</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="p">):</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        Initialize the simulator.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">            config (SimulationConfig): Simulation configuration parameters.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">            behavior (BehaviorAlgorithm): The behavior algorithm governing animal decisions.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">            arena (Arena): The arena environment (shared by all animals).</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">            odor_release_strategy (OdorReleaseStrategy): Strategy for odor deposition.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">            seed (int, optional): Random seed for the simulation&#39;s random number generator.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">=</span> <span class="n">behavior</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">arena</span> <span class="o">=</span> <span class="n">arena</span>  <span class="c1"># shared arena for all animals</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">odor_release_strategy</span> <span class="o">=</span> <span class="n">odor_release_strategy</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_animals</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">number_of_animals</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="c1"># For each agent, create a new instance of the odor perception:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">odor_perceptions</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">config</span><span class="o">.</span><span class="n">odor_perception_factory</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_animals</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>        <span class="p">]</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        Run the simulation step-by-step (unvectorized).</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        This method iterates through each time step and each animal sequentially.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        It performs the following operations in order:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        1. Update animal state (e.g., deciding to turn or walk).</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        2. Release odor into the arena based on the current state.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        3. Calculate antenna positions.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        4. Sample odor concentration at antenna positions.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        5. Process odor perception (filtering, adaptation).</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        6. Update heading based on perceived odor.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">        7. Update position (move) if the path is clear.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        8. Update the global odor field (diffusion and decay).</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">            Dict[str, Any]: A dictionary containing simulation results, including:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">                - &quot;trajectories&quot;: A list of dictionaries, one per animal, containing time-series data</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">                  for position (x, y), heading, state, and odor readings.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">                - &quot;final_odor_grid&quot;: The state of the odor grid at the end of the simulation.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">N</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">total_frames</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_animals</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="c1"># Initialize per-animal arrays.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="n">states</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="n">headings</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="n">xs</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="n">ys</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>        <span class="n">odor_left_arr</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>        <span class="n">odor_right_arr</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="n">perc_odor_left_arr</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="n">perc_odor_right_arr</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="c1"># Reset each agent&#39;s perception at start</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">odor_perceptions</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="c1"># Initialize each animal with a random heading and a random initial position.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">initial_heading_sampler</span><span class="p">()</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">initial_position_sampler</span><span class="p">()</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="c1"># Main simulation loop.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">progress_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># report every 1%</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="c1"># 1) Update state</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                    <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="c1"># 2) Odor release</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="n">deposits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_release_strategy</span><span class="o">.</span><span class="n">release_odor</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                    <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                    <span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                    <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                    <span class="n">cfg</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="k">for</span> <span class="n">deposit</span> <span class="ow">in</span> <span class="n">deposits</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">deposit</span><span class="o">.</span><span class="n">offset</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                    <span class="n">heading_prev</span> <span class="o">=</span> <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                    <span class="n">cos_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">heading_prev</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                    <span class="n">sin_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">heading_prev</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                    <span class="n">global_dx</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">cos_h</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">sin_h</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                    <span class="n">global_dy</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">sin_h</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">cos_h</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                    <span class="n">deposit_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">global_dx</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                    <span class="n">deposit_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">global_dy</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                    <span class="n">kernel</span> <span class="o">=</span> <span class="n">deposit</span><span class="o">.</span><span class="n">generate_kernel</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">deposit_odor_kernel</span><span class="p">(</span><span class="n">deposit_x</span><span class="p">,</span> <span class="n">deposit_y</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="c1"># 3) Compute left/right antenna positions</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="n">cos_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="n">sin_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="n">left_dx</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                    <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_left_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_h</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                    <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_left_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_h</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="n">left_dy</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                    <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_left_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_h</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                    <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_left_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_h</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="n">right_dx</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                    <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_right_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_h</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                    <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_right_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_h</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="n">right_dy</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                    <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_right_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_h</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                    <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_right_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_h</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                <span class="n">left_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">left_dx</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                <span class="n">left_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">left_dy</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                <span class="n">right_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_dx</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                <span class="n">right_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_dy</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="c1"># 4) Sample odor</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="n">odor_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor</span><span class="p">(</span><span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="n">odor_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor</span><span class="p">(</span><span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="n">odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">odor_left</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                <span class="n">odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">odor_right</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="c1"># 5) Perceive odor</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fps</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="n">perc_left</span><span class="p">,</span> <span class="n">perc_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_perceptions</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">perceive_odor</span><span class="p">(</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                    <span class="n">odor_left</span><span class="p">,</span> <span class="n">odor_right</span><span class="p">,</span> <span class="n">dt</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">perc_odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">perc_left</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="n">perc_odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">perc_right</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="c1"># 6) Update heading</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">update_heading</span><span class="p">(</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                    <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">perc_left</span><span class="p">,</span> <span class="n">perc_right</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                <span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                <span class="c1"># 7) Update position if walking</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                <span class="k">if</span> <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                    <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                    <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                    <span class="n">current_speed</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">walking_speed_sampler</span><span class="p">()</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                    <span class="n">walking_distance</span> <span class="o">=</span> <span class="n">current_speed</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fps</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                    <span class="n">new_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">walking_distance</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                    <span class="n">new_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">walking_distance</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">is_free</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">):</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                        <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                        <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                        <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                        <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="c1"># 8) Diffusion / decay</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">diffusion_coefficient</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">odor_decay_rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fps</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">update_odor_field</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="c1"># 9) Progress logging</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">progress_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replicate progress: frame </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">N</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> done)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="s2">&quot;trajectories&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                <span class="p">{</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                    <span class="s2">&quot;heading&quot;</span><span class="p">:</span> <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="s2">&quot;odor_left&quot;</span><span class="p">:</span> <span class="n">odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                    <span class="s2">&quot;odor_right&quot;</span><span class="p">:</span> <span class="n">odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                    <span class="s2">&quot;perc_odor_left&quot;</span><span class="p">:</span> <span class="n">perc_odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                    <span class="s2">&quot;perc_odor_right&quot;</span><span class="p">:</span> <span class="n">perc_odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>                <span class="p">}</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="p">],</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="s2">&quot;final_odor_grid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">odor_grid</span><span class="p">,</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="p">}</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">simulate_vectorized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">        Run a vectorized version of the simulation.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">        This method optimizes the simulation loop by using NumPy vectorization for:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">        - Odor deposition (batching deposits).</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">        - Sensor position calculation (vectorized trigonometry).</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">        - Odor sampling (vectorized grid access).</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">        - Position updates (vectorized movement and collision checking).</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">        Behavioral state updates and heading updates remain per-animal as they may involve</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">        complex, state-dependent logic that is harder to vectorize efficiently.</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="sd">            Dict[str, Any]: A dictionary containing simulation results, structured identically</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">            to `simulate()`.</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">N</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">total_frames</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_animals</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="c1"># Pre-allocate arrays for simulation outputs</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="n">headings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="n">odor_left_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="n">odor_right_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="n">perc_odor_left_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="n">perc_odor_right_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>        <span class="c1"># Initialize positions and headings (still looping over animals for initial values)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">initial_heading_sampler</span><span class="p">()</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">initial_position_sampler</span><span class="p">()</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="c1"># Reset odor perceptions for each agent</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">odor_perceptions</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="c1"># Main simulation loop (over frames)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="c1"># --- State update (scalar per animal) ---</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                    <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                <span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="c1"># --- Odor deposition (vectorized if possible) ---</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="n">deposit_xs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="n">deposit_ys</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="n">kernels</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                <span class="n">deposits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_release_strategy</span><span class="o">.</span><span class="n">release_odor</span><span class="p">(</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                    <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                    <span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                    <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                    <span class="n">cfg</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="p">)</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                <span class="k">for</span> <span class="n">deposit</span> <span class="ow">in</span> <span class="n">deposits</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">deposit</span><span class="o">.</span><span class="n">offset</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                    <span class="c1"># Compute global deposit offset for this animal (scalar)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                    <span class="n">global_dx</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                        <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                    <span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                    <span class="n">global_dy</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                        <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                    <span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                    <span class="n">deposit_xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">global_dx</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                    <span class="n">deposit_ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">global_dy</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                    <span class="n">kernels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deposit</span><span class="o">.</span><span class="n">generate_kernel</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="c1"># If any deposits occurred, try a vectorized deposit if the arena supports it.</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="k">if</span> <span class="n">deposit_xs</span><span class="p">:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>                <span class="n">deposit_xs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deposit_xs</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>                <span class="n">deposit_ys_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deposit_ys</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>                <span class="c1"># Check if all kernels have the same shape.</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">kernels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kernels</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="p">,</span> <span class="s2">&quot;deposit_odor_kernels_vectorized&quot;</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                <span class="p">):</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">deposit_odor_kernels_vectorized</span><span class="p">(</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                        <span class="n">deposit_xs_arr</span><span class="p">,</span> <span class="n">deposit_ys_arr</span><span class="p">,</span> <span class="n">kernels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                    <span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                    <span class="c1"># Fall back to scalar deposits.</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                    <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">deposit_xs</span><span class="p">,</span> <span class="n">deposit_ys</span><span class="p">,</span> <span class="n">kernels</span><span class="p">):</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">deposit_odor_kernel</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="c1"># --- Compute sensor positions vectorized ---</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="c1"># Calculate rotated offsets using vectorized trigonometry.</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="n">current_headings</span> <span class="o">=</span> <span class="n">headings</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># shape (num,)</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="n">cos_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">current_headings</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="n">sin_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">current_headings</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="n">left_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">antenna_left_offset</span><span class="p">)</span>  <span class="c1"># shape (2,)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="n">right_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">antenna_right_offset</span><span class="p">)</span>  <span class="c1"># shape (2,)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>            <span class="n">left_dx</span> <span class="o">=</span> <span class="n">left_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_vals</span> <span class="o">-</span> <span class="n">left_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_vals</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>            <span class="n">left_dy</span> <span class="o">=</span> <span class="n">left_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_vals</span> <span class="o">+</span> <span class="n">left_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_vals</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="n">right_dx</span> <span class="o">=</span> <span class="n">right_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_vals</span> <span class="o">-</span> <span class="n">right_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_vals</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>            <span class="n">right_dy</span> <span class="o">=</span> <span class="n">right_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_vals</span> <span class="o">+</span> <span class="n">right_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_vals</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="n">left_sensor_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">left_dx</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="n">left_sensor_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">left_dy</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="n">right_sensor_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_dx</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>            <span class="n">right_sensor_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_dy</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="c1"># --- Get odor sensor readings vectorized ---</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="c1"># We assume your arena provides a vectorized get_odor_vectorized method.</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="p">,</span> <span class="s2">&quot;get_odor_vectorized&quot;</span><span class="p">):</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                <span class="n">odor_left_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor_vectorized</span><span class="p">(</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                    <span class="n">left_sensor_x</span><span class="p">,</span> <span class="n">left_sensor_y</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                <span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                <span class="n">odor_right_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor_vectorized</span><span class="p">(</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                    <span class="n">right_sensor_x</span><span class="p">,</span> <span class="n">right_sensor_y</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                <span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                <span class="n">odor_left_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                    <span class="p">[</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">left_sensor_x</span><span class="p">,</span> <span class="n">left_sensor_y</span><span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                    <span class="p">]</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>                <span class="p">)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                <span class="n">odor_right_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                    <span class="p">[</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">right_sensor_x</span><span class="p">,</span> <span class="n">right_sensor_y</span><span class="p">)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                    <span class="p">]</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                <span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="n">odor_left_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">odor_left_vals</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="n">odor_right_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">odor_right_vals</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="c1"># --- Update perceived odor (still per-animal) ---</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>            <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fps</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                <span class="n">perc_left</span><span class="p">,</span> <span class="n">perc_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_perceptions</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">perceive_odor</span><span class="p">(</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                    <span class="n">odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dt</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                <span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                <span class="n">perc_odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">perc_left</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                <span class="n">perc_odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">perc_right</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="c1"># --- Update headings (per-animal) ---</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>                <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">update_heading</span><span class="p">(</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>                    <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>                    <span class="n">perc_odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>                    <span class="n">perc_odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>                    <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>                    <span class="n">cfg</span><span class="p">,</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>                <span class="p">)</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>            <span class="c1"># --- Compute new positions vectorized ---</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>            <span class="c1"># Compute walking distances for each animal.</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>            <span class="n">current_speeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cfg</span><span class="o">.</span><span class="n">walking_speed_sampler</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)])</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="n">walking_distance</span> <span class="o">=</span> <span class="n">current_speeds</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fps</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="n">proposed_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">headings</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">walking_distance</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="n">proposed_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">headings</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">walking_distance</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="c1"># Use vectorized free-space check if available.</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="p">,</span> <span class="s2">&quot;is_free_vectorized&quot;</span><span class="p">):</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>                <span class="n">free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">is_free_vectorized</span><span class="p">(</span><span class="n">proposed_x</span><span class="p">,</span> <span class="n">proposed_y</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>                <span class="n">free</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">is_free</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">proposed_x</span><span class="p">,</span> <span class="n">proposed_y</span><span class="p">)]</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                <span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="n">xs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">free</span><span class="p">,</span> <span class="n">proposed_x</span><span class="p">,</span> <span class="n">xs</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="n">ys</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">free</span><span class="p">,</span> <span class="n">proposed_y</span><span class="p">,</span> <span class="n">ys</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="c1"># --- Update the odor field ---</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">diffusion_coefficient</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">odor_decay_rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">update_odor_field</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                    <span class="sa">f</span><span class="s2">&quot;Vectorized simulation progress: frame </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">N</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> done)&quot;</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>                <span class="p">)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="c1"># Pack the result into a dictionary.</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>            <span class="s2">&quot;trajectories&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>                <span class="p">{</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>                    <span class="s2">&quot;heading&quot;</span><span class="p">:</span> <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                    <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                    <span class="s2">&quot;odor_left&quot;</span><span class="p">:</span> <span class="n">odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>                    <span class="s2">&quot;odor_right&quot;</span><span class="p">:</span> <span class="n">odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                    <span class="s2">&quot;perceived_odor_left&quot;</span><span class="p">:</span> <span class="n">perc_odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                    <span class="s2">&quot;perceived_odor_right&quot;</span><span class="p">:</span> <span class="n">perc_odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                <span class="p">}</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>            <span class="p">],</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>            <span class="s2">&quot;final_odor_grid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">odor_grid</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="p">}</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="arthroscape.sim.simulator.MultiAnimalSimulator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">behavior</span><span class="p">,</span> <span class="n">arena</span><span class="p">,</span> <span class="n">odor_release_strategy</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the simulator.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="SimulationConfig


  
      dataclass
   (arthroscape.sim.config.SimulationConfig)" href="../config/#arthroscape.sim.config.SimulationConfig">SimulationConfig</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Simulation configuration parameters.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>behavior</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="BehaviorAlgorithm (arthroscape.sim.behavior.BehaviorAlgorithm)" href="../behavior/#arthroscape.sim.behavior.BehaviorAlgorithm">BehaviorAlgorithm</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The behavior algorithm governing animal decisions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>arena</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Arena (arthroscape.sim.arena.Arena)" href="../arena/#arthroscape.sim.arena.Arena">Arena</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The arena environment (shared by all animals).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>odor_release_strategy</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="OdorReleaseStrategy (arthroscape.sim.odor_release.OdorReleaseStrategy)" href="../odor_release/#arthroscape.sim.odor_release.OdorReleaseStrategy">OdorReleaseStrategy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Strategy for odor deposition.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>seed</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Random seed for the simulation's random number generator.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>arthroscape/sim/simulator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">config</span><span class="p">:</span> <span class="n">SimulationConfig</span><span class="p">,</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">behavior</span><span class="p">:</span> <span class="n">BehaviorAlgorithm</span><span class="p">,</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">arena</span><span class="p">:</span> <span class="n">Arena</span><span class="p">,</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">odor_release_strategy</span><span class="p">:</span> <span class="n">OdorReleaseStrategy</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="p">):</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">    Initialize the simulator.</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        config (SimulationConfig): Simulation configuration parameters.</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        behavior (BehaviorAlgorithm): The behavior algorithm governing animal decisions.</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        arena (Arena): The arena environment (shared by all animals).</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        odor_release_strategy (OdorReleaseStrategy): Strategy for odor deposition.</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        seed (int, optional): Random seed for the simulation&#39;s random number generator.</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span> <span class="o">=</span> <span class="n">behavior</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">arena</span> <span class="o">=</span> <span class="n">arena</span>  <span class="c1"># shared arena for all animals</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">odor_release_strategy</span> <span class="o">=</span> <span class="n">odor_release_strategy</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">num_animals</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">number_of_animals</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>    <span class="c1"># For each agent, create a new instance of the odor perception:</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">odor_perceptions</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">config</span><span class="o">.</span><span class="n">odor_perception_factory</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_animals</span><span class="p">)</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>    <span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="arthroscape.sim.simulator.MultiAnimalSimulator.simulate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">simulate</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Run the simulation step-by-step (unvectorized).</p>
<p>This method iterates through each time step and each animal sequentially.
It performs the following operations in order:
1. Update animal state (e.g., deciding to turn or walk).
2. Release odor into the arena based on the current state.
3. Calculate antenna positions.
4. Sample odor concentration at antenna positions.
5. Process odor perception (filtering, adaptation).
6. Update heading based on perceived odor.
7. Update position (move) if the path is clear.
8. Update the global odor field (diffusion and decay).</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: A dictionary containing simulation results, including:
- "trajectories": A list of dictionaries, one per animal, containing time-series data
  for position (x, y), heading, state, and odor readings.
- "final_odor_grid": The state of the odor grid at the end of the simulation.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>arthroscape/sim/simulator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="k">def</span><span class="w"> </span><span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    Run the simulation step-by-step (unvectorized).</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    This method iterates through each time step and each animal sequentially.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    It performs the following operations in order:</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    1. Update animal state (e.g., deciding to turn or walk).</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    2. Release odor into the arena based on the current state.</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    3. Calculate antenna positions.</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">    4. Sample odor concentration at antenna positions.</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    5. Process odor perception (filtering, adaptation).</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">    6. Update heading based on perceived odor.</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">    7. Update position (move) if the path is clear.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    8. Update the global odor field (diffusion and decay).</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        Dict[str, Any]: A dictionary containing simulation results, including:</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            - &quot;trajectories&quot;: A list of dictionaries, one per animal, containing time-series data</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">              for position (x, y), heading, state, and odor readings.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">            - &quot;final_odor_grid&quot;: The state of the odor grid at the end of the simulation.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="n">N</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">total_frames</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_animals</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>    <span class="c1"># Initialize per-animal arrays.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>    <span class="n">states</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="n">headings</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>    <span class="n">xs</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>    <span class="n">ys</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>    <span class="n">odor_left_arr</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>    <span class="n">odor_right_arr</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>    <span class="n">perc_odor_left_arr</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>    <span class="n">perc_odor_right_arr</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)]</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="c1"># Reset each agent&#39;s perception at start</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">odor_perceptions</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="c1"># Initialize each animal with a random heading and a random initial position.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">initial_heading_sampler</span><span class="p">()</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">initial_position_sampler</span><span class="p">()</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="c1"># Main simulation loop.</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">progress_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># report every 1%</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="c1"># 1) Update state</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="c1"># 2) Odor release</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">deposits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_release_strategy</span><span class="o">.</span><span class="n">release_odor</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="n">cfg</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="k">for</span> <span class="n">deposit</span> <span class="ow">in</span> <span class="n">deposits</span><span class="p">:</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">deposit</span><span class="o">.</span><span class="n">offset</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="n">heading_prev</span> <span class="o">=</span> <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="n">cos_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">heading_prev</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="n">sin_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">heading_prev</span><span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="n">global_dx</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">cos_h</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">sin_h</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                <span class="n">global_dy</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">sin_h</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">cos_h</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                <span class="n">deposit_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">global_dx</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="n">deposit_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">global_dy</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="n">kernel</span> <span class="o">=</span> <span class="n">deposit</span><span class="o">.</span><span class="n">generate_kernel</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">deposit_odor_kernel</span><span class="p">(</span><span class="n">deposit_x</span><span class="p">,</span> <span class="n">deposit_y</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="c1"># 3) Compute left/right antenna positions</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="n">cos_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="n">sin_h</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="n">left_dx</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_left_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_h</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_left_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_h</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="n">left_dy</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_left_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_h</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_left_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_h</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="p">)</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="n">right_dx</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_right_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_h</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="o">-</span> <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_right_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_h</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">right_dy</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_right_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_h</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="o">+</span> <span class="n">cfg</span><span class="o">.</span><span class="n">antenna_right_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_h</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="n">left_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">left_dx</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">left_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">left_dy</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">right_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_dx</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">right_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_dy</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="c1"># 4) Sample odor</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="n">odor_left</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor</span><span class="p">(</span><span class="n">left_x</span><span class="p">,</span> <span class="n">left_y</span><span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>            <span class="n">odor_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor</span><span class="p">(</span><span class="n">right_x</span><span class="p">,</span> <span class="n">right_y</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="n">odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">odor_left</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>            <span class="n">odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">odor_right</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="c1"># 5) Perceive odor</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fps</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="n">perc_left</span><span class="p">,</span> <span class="n">perc_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_perceptions</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">perceive_odor</span><span class="p">(</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="n">odor_left</span><span class="p">,</span> <span class="n">odor_right</span><span class="p">,</span> <span class="n">dt</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="p">)</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="n">perc_odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">perc_left</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="n">perc_odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">perc_right</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>            <span class="c1"># 6) Update heading</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">update_heading</span><span class="p">(</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">perc_left</span><span class="p">,</span> <span class="n">perc_right</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="c1"># 7) Update position if walking</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="k">if</span> <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                <span class="n">current_speed</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">walking_speed_sampler</span><span class="p">()</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                <span class="n">walking_distance</span> <span class="o">=</span> <span class="n">current_speed</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fps</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                <span class="n">new_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">walking_distance</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                <span class="n">new_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">walking_distance</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">is_free</span><span class="p">(</span><span class="n">new_x</span><span class="p">,</span> <span class="n">new_y</span><span class="p">):</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                    <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_x</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                    <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_y</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                    <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                    <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="c1"># 8) Diffusion / decay</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">diffusion_coefficient</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">odor_decay_rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fps</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">update_odor_field</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="c1"># 9) Progress logging</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="n">progress_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replicate progress: frame </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">N</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> done)&quot;</span><span class="p">)</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="s2">&quot;trajectories&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="p">{</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                <span class="s2">&quot;heading&quot;</span><span class="p">:</span> <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="s2">&quot;odor_left&quot;</span><span class="p">:</span> <span class="n">odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="s2">&quot;odor_right&quot;</span><span class="p">:</span> <span class="n">odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="s2">&quot;perc_odor_left&quot;</span><span class="p">:</span> <span class="n">perc_odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="s2">&quot;perc_odor_right&quot;</span><span class="p">:</span> <span class="n">perc_odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">],</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="p">}</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="p">],</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="s2">&quot;final_odor_grid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">odor_grid</span><span class="p">,</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>    <span class="p">}</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="arthroscape.sim.simulator.MultiAnimalSimulator.simulate_vectorized" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">simulate_vectorized</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Run a vectorized version of the simulation.</p>
<p>This method optimizes the simulation loop by using NumPy vectorization for:
- Odor deposition (batching deposits).
- Sensor position calculation (vectorized trigonometry).
- Odor sampling (vectorized grid access).
- Position updates (vectorized movement and collision checking).</p>
<p>Behavioral state updates and heading updates remain per-animal as they may involve
complex, state-dependent logic that is harder to vectorize efficiently.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dict[str, Any]: A dictionary containing simulation results, structured identically</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>to <code>simulate()</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>arthroscape/sim/simulator.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="k">def</span><span class="w"> </span><span class="nf">simulate_vectorized</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a><span class="sd">    Run a vectorized version of the simulation.</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="sd">    This method optimizes the simulation loop by using NumPy vectorization for:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a><span class="sd">    - Odor deposition (batching deposits).</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a><span class="sd">    - Sensor position calculation (vectorized trigonometry).</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="sd">    - Odor sampling (vectorized grid access).</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="sd">    - Position updates (vectorized movement and collision checking).</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a><span class="sd">    Behavioral state updates and heading updates remain per-animal as they may involve</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a><span class="sd">    complex, state-dependent logic that is harder to vectorize efficiently.</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a><span class="sd">        Dict[str, Any]: A dictionary containing simulation results, structured identically</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a><span class="sd">        to `simulate()`.</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>    <span class="n">cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>    <span class="n">N</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">total_frames</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="n">num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_animals</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="c1"># Pre-allocate arrays for simulation outputs</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="n">states</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="n">headings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">ys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="n">odor_left_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>    <span class="n">odor_right_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="n">perc_odor_left_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>    <span class="n">perc_odor_right_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>    <span class="c1"># Initialize positions and headings (still looping over animals for initial values)</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>        <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">initial_heading_sampler</span><span class="p">()</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">initial_position_sampler</span><span class="p">()</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>    <span class="c1"># Reset odor perceptions for each agent</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">odor_perceptions</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>    <span class="c1"># Main simulation loop (over frames)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="c1"># --- State update (scalar per animal) ---</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="c1"># --- Odor deposition (vectorized if possible) ---</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">deposit_xs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="n">deposit_ys</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="n">kernels</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="n">deposits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_release_strategy</span><span class="o">.</span><span class="n">release_odor</span><span class="p">(</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                <span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                <span class="n">cfg</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="p">)</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="k">for</span> <span class="n">deposit</span> <span class="ow">in</span> <span class="n">deposits</span><span class="p">:</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">deposit</span><span class="o">.</span><span class="n">offset</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="c1"># Compute global deposit offset for this animal (scalar)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                <span class="n">global_dx</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                    <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                <span class="n">global_dy</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>                    <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                <span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                <span class="n">deposit_xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">global_dx</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                <span class="n">deposit_ys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">global_dy</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                <span class="n">kernels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">deposit</span><span class="o">.</span><span class="n">generate_kernel</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="c1"># If any deposits occurred, try a vectorized deposit if the arena supports it.</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="k">if</span> <span class="n">deposit_xs</span><span class="p">:</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="n">deposit_xs_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deposit_xs</span><span class="p">)</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="n">deposit_ys_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deposit_ys</span><span class="p">)</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>            <span class="c1"># Check if all kernels have the same shape.</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">kernels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kernels</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="p">,</span> <span class="s2">&quot;deposit_odor_kernels_vectorized&quot;</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="p">):</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">deposit_odor_kernels_vectorized</span><span class="p">(</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                    <span class="n">deposit_xs_arr</span><span class="p">,</span> <span class="n">deposit_ys_arr</span><span class="p">,</span> <span class="n">kernels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                <span class="c1"># Fall back to scalar deposits.</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>                <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">deposit_xs</span><span class="p">,</span> <span class="n">deposit_ys</span><span class="p">,</span> <span class="n">kernels</span><span class="p">):</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">deposit_odor_kernel</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="c1"># --- Compute sensor positions vectorized ---</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="c1"># Calculate rotated offsets using vectorized trigonometry.</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="n">current_headings</span> <span class="o">=</span> <span class="n">headings</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># shape (num,)</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="n">cos_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">current_headings</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="n">sin_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">current_headings</span><span class="p">)</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">left_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">antenna_left_offset</span><span class="p">)</span>  <span class="c1"># shape (2,)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="n">right_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">antenna_right_offset</span><span class="p">)</span>  <span class="c1"># shape (2,)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="n">left_dx</span> <span class="o">=</span> <span class="n">left_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_vals</span> <span class="o">-</span> <span class="n">left_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_vals</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="n">left_dy</span> <span class="o">=</span> <span class="n">left_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_vals</span> <span class="o">+</span> <span class="n">left_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_vals</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="n">right_dx</span> <span class="o">=</span> <span class="n">right_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_vals</span> <span class="o">-</span> <span class="n">right_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_vals</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="n">right_dy</span> <span class="o">=</span> <span class="n">right_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin_vals</span> <span class="o">+</span> <span class="n">right_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos_vals</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="n">left_sensor_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">left_dx</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="n">left_sensor_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">left_dy</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="n">right_sensor_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_dx</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="n">right_sensor_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">right_dy</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="c1"># --- Get odor sensor readings vectorized ---</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="c1"># We assume your arena provides a vectorized get_odor_vectorized method.</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="p">,</span> <span class="s2">&quot;get_odor_vectorized&quot;</span><span class="p">):</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>            <span class="n">odor_left_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor_vectorized</span><span class="p">(</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                <span class="n">left_sensor_x</span><span class="p">,</span> <span class="n">left_sensor_y</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>            <span class="n">odor_right_vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor_vectorized</span><span class="p">(</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>                <span class="n">right_sensor_x</span><span class="p">,</span> <span class="n">right_sensor_y</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="n">odor_left_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                <span class="p">[</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">left_sensor_x</span><span class="p">,</span> <span class="n">left_sensor_y</span><span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                <span class="p">]</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="p">)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="n">odor_right_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                <span class="p">[</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">get_odor</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">right_sensor_x</span><span class="p">,</span> <span class="n">right_sensor_y</span><span class="p">)</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                <span class="p">]</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="p">)</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="n">odor_left_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">odor_left_vals</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="n">odor_right_arr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">odor_right_vals</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="c1"># --- Update perceived odor (still per-animal) ---</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fps</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>            <span class="n">perc_left</span><span class="p">,</span> <span class="n">perc_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">odor_perceptions</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">perceive_odor</span><span class="p">(</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                <span class="n">odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">dt</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>            <span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="n">perc_odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">perc_left</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="n">perc_odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">perc_right</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="c1"># --- Update headings (per-animal) ---</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">behavior</span><span class="o">.</span><span class="n">update_heading</span><span class="p">(</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>                <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>                <span class="n">perc_odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>                <span class="n">perc_odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>                <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>                <span class="n">cfg</span><span class="p">,</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>            <span class="p">)</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="c1"># --- Compute new positions vectorized ---</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>        <span class="c1"># Compute walking distances for each animal.</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="n">current_speeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cfg</span><span class="o">.</span><span class="n">walking_speed_sampler</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)])</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="n">walking_distance</span> <span class="o">=</span> <span class="n">current_speeds</span> <span class="o">/</span> <span class="n">cfg</span><span class="o">.</span><span class="n">fps</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="n">proposed_x</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">headings</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">walking_distance</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="n">proposed_y</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">headings</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">walking_distance</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="c1"># Use vectorized free-space check if available.</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="p">,</span> <span class="s2">&quot;is_free_vectorized&quot;</span><span class="p">):</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>            <span class="n">free</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">is_free_vectorized</span><span class="p">(</span><span class="n">proposed_x</span><span class="p">,</span> <span class="n">proposed_y</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="n">free</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">is_free</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">proposed_x</span><span class="p">,</span> <span class="n">proposed_y</span><span class="p">)]</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="n">xs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">free</span><span class="p">,</span> <span class="n">proposed_x</span><span class="p">,</span> <span class="n">xs</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="n">ys</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">free</span><span class="p">,</span> <span class="n">proposed_y</span><span class="p">,</span> <span class="n">ys</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="c1"># --- Update the odor field ---</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">diffusion_coefficient</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">odor_decay_rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">update_odor_field</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">100</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>                <span class="sa">f</span><span class="s2">&quot;Vectorized simulation progress: frame </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">N</span><span class="si">:</span><span class="s2">.0%</span><span class="si">}</span><span class="s2"> done)&quot;</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="p">)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>    <span class="c1"># Pack the result into a dictionary.</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="s2">&quot;trajectories&quot;</span><span class="p">:</span> <span class="p">[</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="p">{</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">xs</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">ys</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>                <span class="s2">&quot;heading&quot;</span><span class="p">:</span> <span class="n">headings</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">states</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>                <span class="s2">&quot;odor_left&quot;</span><span class="p">:</span> <span class="n">odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>                <span class="s2">&quot;odor_right&quot;</span><span class="p">:</span> <span class="n">odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>                <span class="s2">&quot;perceived_odor_left&quot;</span><span class="p">:</span> <span class="n">perc_odor_left_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>                <span class="s2">&quot;perceived_odor_right&quot;</span><span class="p">:</span> <span class="n">perc_odor_right_arr</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>            <span class="p">}</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="p">],</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="s2">&quot;final_odor_grid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">arena</span><span class="o">.</span><span class="n">odor_grid</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>    <span class="p">}</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "toc.integrate", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>