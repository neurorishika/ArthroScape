# Usage Guide

ArthroScape can be used in two primary ways:

1. **Command Line Interface (CLI)**: For quick simulations using standard arenas and parameters.
2. **Python API**: For full control over configuration, custom behaviors, and complex experiments.

## Command Line Interface (CLI)

The easiest way to run simulations is using the provided script `scripts/run_simulation.py`.

### Basic Syntax

```bash
poetry run python scripts/run_simulation.py [OPTIONS]
```

### Common Options

| Option | Description | Default |
| :--- | :--- | :--- |
| `--arena` | Arena type (`circular`, `pbc`, `pbc-line`) | `circular` |
| `--animals` | Number of animals per replicate | `1` |
| `--replicates` | Number of independent simulations to run | `1` |
| `--odor_release` | Odor strategy (`constant`, `conditional`, `none`) | `constant` |
| `--visualize` | Generate plots and animations after simulation | `False` |
| `--parallel` | Run replicates in parallel | `False` |
| `--save` | Custom path for the output `.h5` file | Auto-generated |

### External Odor Source Options

| Option | Description | Default |
| :--- | :--- | :--- |
| `--odor_image` | Path to an image file to use as static odor landscape | None |
| `--odor_video` | Path to a video file to use as dynamic odor field | None |
| `--odor_scale` | Scaling factor for external odor values | `1.0` |
| `--odor_invert` | Invert the odor source (dark = high concentration) | `False` |
| `--odor_mode` | How to apply odor (`replace`, `add`, `multiply`, `max`) | `replace` |
| `--video_loop` | Loop the video when it ends | `False` |
| `--video_sync` | Video sync mode (`one_to_one`, `video_fps`, `simulation_fps`) | `simulation_fps` |

### Examples

#### 1. Circular Arena with 5 Animals

Run a simulation in a circular arena with 5 animals, and visualize the results.

```bash
poetry run python scripts/run_simulation.py --arena circular --animals 5 --visualize
```

#### 2. Periodic Boundary Conditions (PBC)

Run a simulation in a square arena with periodic boundaries (toroidal), with 10 animals and no odor release.

```bash
poetry run python scripts/run_simulation.py --arena pbc --animals 10 --odor_release none --visualize
```

#### 3. High-Throughput Parallel Simulation

Run 20 replicates of a single-animal simulation in parallel, without visualization (faster).

```bash
poetry run python scripts/run_simulation.py --arena pbc --animals 1 --replicates 20 --parallel
```

#### 4. Using an Image as Odor Landscape

Load a grayscale image as the odor map. Brighter pixels = higher concentration.

```bash
poetry run python scripts/run_simulation.py --arena pbc --animals 5 \
    --odor_image path/to/odor_map.png --odor_scale 10.0 --visualize
```

#### 5. Inverting an Image (Dark = High Odor)

If your image has dark regions representing high odor concentration, use `--odor_invert`.

```bash
poetry run python scripts/run_simulation.py --arena pbc --animals 5 \
    --odor_image path/to/dark_plume.png --odor_invert --odor_scale 5.0
```

#### 6. Combining Image Odor with Agent Pheromone

Add an image-based background odor while agents also release pheromone.

```bash
poetry run python scripts/run_simulation.py --arena pbc --animals 10 \
    --odor_image food_source.png --odor_mode add --odor_scale 2.0 \
    --odor_release constant --deposit_amount 0.1 --visualize
```

#### 7. Using a Video as Dynamic Odor Field

Load a video where each frame represents the odor landscape at that time step.

```bash
poetry run python scripts/run_simulation.py --arena pbc --animals 5 \
    --odor_video plume_recording.mp4 --odor_scale 3.0 --video_loop --visualize
```

!!! note "Video Odor Source Limitation"
    The standard CLI runner applies only the first frame of the video as the initial odor state.
    For true per-frame video updates, use a custom simulation loop with the Python API.
    See the [External Odor Sources How-To Guide](how-to/external_odor_sources.md) for details.

## Graphical Analysis Tool

ArthroScape includes a graphical user interface (GUI) for analyzing simulation results.

### Launching the UI

```bash
poetry run python scripts/analysis_ui.py
```

### Features

* **Load Data**: Select an HDF5 results file (`.h5`) generated by a simulation.
* **Output Folder**: Choose where to save the analysis plots.
* **Analysis Options**:
  * **Trajectories Plot**: Visualizes agent paths overlaid on the odor landscape.
  * **Odor Grid**: Shows the final state of the odor concentration field.
  * **Odor Time Series**: Plots the odor concentration experienced by agents over time.
  * **Animation Video**: Generates an MP4 video of the simulation.
  * **Wraparound**: Enable this for PBC arenas to correctly visualize trajectories crossing boundaries.

## Advanced Configuration (Python API)

For advanced use cases, you should configure the simulation using a Python script. This allows you to modify parameters not exposed in the CLI.

### Setting up a Configuration

The `SimulationConfig` class in `arthroscape.sim.config` holds all simulation parameters. You can instantiate this class with custom values.

```python
from arthroscape.sim.config import SimulationConfig
from arthroscape.sim.main import run_simulations_vectorized
# ... import other components ...

# 1. Create a custom configuration
config = SimulationConfig(
    T=300.0,                # Duration in seconds
    fps=60.0,               # Frames per second
    walking_speed=20.0,     # mm/s
    turn_rate=1.5,          # Hz
    grid_resolution=0.5,    # mm per cell
    # ... other parameters ...
)

# 2. Run simulation with this config
# (See 'Tutorials > Getting Started' for full script example)
```

### Key Configuration Parameters

* **`T`**: Total simulation time (seconds).
* **`walking_speed`**: Agent speed (mm/s).
* **`turn_rate`**: Frequency of turns (Hz).
* **`asymmetry_factor`**: Strength of turning bias due to odor gradients.
* **`odor_decay_tau`**: Time constant for odor decay (set to `np.inf` for no decay).
* **`diffusion_coefficient`**: Rate of odor diffusion.

See the [Config API Reference](api/sim/config.md) for the full list of parameters.

### Modifying Defaults

If you want to change the default parameters used by the CLI (e.g., `scripts/run_simulation.py`), you can modify the default values in `arthroscape/sim/config.py` directly. Note that this will affect all simulations that rely on the default configuration.
